{% extends 'base.html' %}
{% block content %}
<h3>{{ 'New' if not game else 'Edit' }} Game</h3>

<form method="post">
  <div class="row g-3">
    <div class="col-md-4">
      <label class="form-label">Home Team</label>
      <input class="form-control" name="home_team" value="{{ game.home_team if game else '' }}" required>
    </div>
    <div class="col-md-4">
      <label class="form-label">Away Team</label>
      <input class="form-control" name="away_team" value="{{ game.away_team if game else '' }}" required>
    </div>
    <div class="col-md-4">
      <label class="form-label">Start (YYYY-MM-DD HH:MM)</label>
      <input class="form-control" name="start_time" value="{{ game.start_time.strftime('%Y-%m-%d %H:%M') if game else '' }}" required>
    </div>

    {% if game %}
    <div class="col-md-3">
      <label class="form-label">Status</label>
      <select class="form-select" name="status">
        <option value="open"   {% if game.status=='open' %}selected{% endif %}>open</option>
        <option value="closed" {% if game.status=='closed' %}selected{% endif %}>closed</option>
        <option value="graded" {% if game.status=='graded' %}selected{% endif %}>graded</option>
      </select>
    </div>
    {% endif %}

    <div class="col-md-2">
      <label class="form-label">ML Home</label>
      <input class="form-control" name="ml_home" value="{{ game.ml_home if game else '' }}">
    </div>
    <div class="col-md-2">
      <label class="form-label">ML Away</label>
      <input class="form-control" name="ml_away" value="{{ game.ml_away if game else '' }}">
    </div>

    <div class="col-md-2">
      <label class="form-label">Spread (home)</label>
      <input class="form-control" name="spread_line" value="{{ game.spread_line if game else '' }}" placeholder="-6.5">
    </div>
    <div class="col-md-2">
      <label class="form-label">Spread Home Odds</label>
      <input class="form-control" name="spread_home_odds" value="{{ game.spread_home_odds if game else '' }}" placeholder="-110">
    </div>
    <div class="col-md-2">
      <label class="form-label">Spread Away Odds</label>
      <input class="form-control" name="spread_away_odds" value="{{ game.spread_away_odds if game else '' }}" placeholder="-110">
    </div>

    <div class="col-md-2">
      <label class="form-label">Total (O/U)</label>
      <input class="form-control" name="total_points" value="{{ game.total_points if game else '' }}" placeholder="55.5">
    </div>
    <div class="col-md-2">
      <label class="form-label">Over Odds</label>
      <input class="form-control" name="over_odds" value="{{ game.over_odds if game else '' }}" placeholder="-110">
    </div>
    <div class="col-md-2">
      <label class="form-label">Under Odds</label>
      <input class="form-control" name="under_odds" value="{{ game.under_odds if game else '' }}" placeholder="-110">
    </div>
  </div>

  <div class="mt-3">
    <button class="btn btn-primary">Save Game Details</button>
    <a class="btn btn-secondary" href="{{ url_for('admin_games') }}">Cancel</a>
  </div>
</form>

{% if not game %}
  <hr>
  <p class="text-muted">Save this game first to add props.</p>
{% else %}
  <hr>
  <div class="d-flex align-items-center justify-content-between mb-2">
    <h4 class="mb-0">Props for {{ game.away_team }} @ {{ game.home_team }}</h4>
  </div>

  <div class="card mb-3">
    <div class="card-body">
      <h5 class="card-title">Add New Prop</h5>

      <form method="post" action="{{ url_for('admin_prop_new', game_id=game.id) }}">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Name (e.g., "QB Passing Yards")</label>
            <input class="form-control" name="name" placeholder="Prop name" required>
          </div>

          <div class="col-md-6">
            <label class="form-label">Type</label>
            <select class="form-select" name="prop_type" id="prop-type-select" required>
              <option value="OU" selected>Over/Under</option>
              <option value="YN">Yes / No</option>
            </select>
          </div>

          <div id="ou-fields" class="row g-3 col-12">
            <div class="col-md-4">
              <label class="form-label">Line (OU only)</label>
              <input class="form-control" name="line" step="0.01" placeholder="e.g. 265.5">
            </div>
            <div class="col-md-4">
              <label class="form-label">Over Odds (OU)</label>
              <input class="form-control" name="over_odds" placeholder="-110">
            </div>
            <div class="col-md-4">
              <label class="form-label">Under Odds (OU)</label>
              <input class="form-control" name="under_odds" placeholder="-110">
            </div>
          </div>
          
          <div id="yn-fields" class="row g-3 col-12">
            <div class="col-md-6">
              <label class="form-label">Yes Odds (YN)</label>
              <input class="form-control" name="yes_odds" placeholder="+150">
            </div>
            <div class="col-md-6">
              <label class="form-label">No Odds (YN)</label>
              <input class="form-control" name="no_odds" placeholder="-170">
            </div>
          </div>

        </div>

        <div class="mt-3">
          <button class="btn btn-success">Add Prop</button>
        </div>
      </form>
    </div>
  </div>

  {% set props_list = props if props is defined else (game.props if game.props is defined else []) %}
  <div class="card">
    <div class="card-body">
      <h5 class="card-title">Existing Props</h5>
      {% if props_list and props_list|length > 0 %}
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>ID</th><th>Name</th><th>Type</th>
                <th class="text-center">Line</th>
                <th class="text-center">Odds</th>
                <th class="text-center">Status</th>
                <th class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for p in props_list %}
              <tr>
                <td>{{ p.id }}</td>
                <td>{{ p.name }}</td>
                <td>{{ p.prop_type }}</td>
                <td class="text-center">{% if p.prop_type == 'OU' %}{{ p.line }}{% else %}â€”{% endif %}</td>
                <td class="text-center">
                  {% if p.prop_type == 'OU' %}
                    O {{ p.over_odds }} / U {{ p.under_odds }}
                  {% else %}
                    YES {{ p.yes_odds }} / NO {{ p.no_odds }}
                  {% endif %}
                </td>
                <td class="text-center">{{ p.status }}</td>
                <td class="text-center">
                  <form class="d-inline" method="post" action="{{ url_for('admin_prop_status', prop_id=p.id) }}">
                    <input type="hidden" name="status" value="{{ 'closed' if p.status=='open' else 'open' }}">
                    <button class="btn btn-outline-secondary btn-sm">
                      {{ 'Close' if p.status=='open' else 'Open' }}
                    </button>
                  </form>

                  {# --- ADDED THIS DELETE BUTTON FORM --- #}
                  <form class="d-inline ms-1" method="post" action="{{ url_for('admin_delete_prop', prop_id=p.id) }}" onsubmit="return confirm('Are you sure you want to delete this prop?');">
                      <button class="btn btn-danger btn-sm">Delete</button>
                  </form>

                  {% if p.status != 'graded' %}
                    {% if p.prop_type == 'OU' %}
                      <form class="d-inline ms-1" method="post" action="{{ url_for('admin_grade_prop', prop_id=p.id) }}">
                        <input type="number" step="0.01" class="form-control form-control-sm d-inline-block" style="width:120px"
                               name="result_value" placeholder="Result value" required>
                        <button class="btn btn-success btn-sm">Grade</button>
                      </form>
                    {% else %}
                      <form class="d-inline ms-1" method="post" action="{{ url_for('admin_grade_prop', prop_id=p.id) }}">
                        <select name="result_bool" class="form-select form-select-sm d-inline-block" style="width:120px">
                          <option value="true">YES</option>
                          <option value="false">NO</option>
                        </select>
                        <button class="btn btn-success btn-sm">Grade</button>
                      </form>
                    {% endif %}
                  {% else %}
                    <span class="badge bg-success ms-1">graded</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="text-muted mb-0">No props yet for this game.</p>
      {% endif %}
    </div>
  </div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
  const propTypeSelect = document.getElementById('prop-type-select');
  const ouFields = document.getElementById('ou-fields');
  const ynFields = document.getElementById('yn-fields');

  function togglePropFields() {
    if(!propTypeSelect) return; // Don't run on pages without this element
    if (propTypeSelect.value === 'OU') {
      ouFields.style.display = 'flex'; 
      ynFields.style.display = 'none';
    } else { // 'YN'
      ouFields.style.display = 'none';
      ynFields.style.display = 'flex';
    }
  }
  togglePropFields();
  propTypeSelect.addEventListener('change', togglePropFields);
});
</script>

{% endblock %}