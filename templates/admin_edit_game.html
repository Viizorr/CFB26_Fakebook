{% extends 'base.html' %}
{% block content %}
<h3>{{ 'New' if not game else 'Edit' }} Game</h3>

<form method="post" action="{{ url_for('admin_edit_game', game_id=game.id) if game else url_for('admin_new_game') }}">
  <div class="row g-3">
    <!-- game core fields -->
    <div class="col-md-4">
      <label class="form-label">Home Team</label>
      <input class="form-control" name="home_team" value="{{ game.home_team if game else '' }}" required>
    </div>
    <div class="col-md-4">
      <label class="form-label">Away Team</label>
      <input class="form-control" name="away_team" value="{{ game.away_team if game else '' }}" required>
    </div>
    <div class="col-md-4">
      <label class="form-label">Start (YYYY-MM-DD HH:MM)</label>
      <input class="form-control" name="start_time" value="{{ game.start_time.strftime('%Y-%m-%d %H:%M') if game else '' }}" required>
    </div>

    <div class="col-md-9">
      <label class="form-label">Tags (comma-separated)</label>
      <input class="form-control" name="tags" value="{{ (game.tags | map(attribute='name') | join(', ')) if game and game.tags }}">
    </div>

    {% if game %}
    <div class="col-md-3">
      <label class="form-label">Status</label>
      <select class="form-select" name="status">
        <option value="open"   {% if game.status=='open' %}selected{% endif %}>open</option>
        <option value="closed" {% if game.status=='closed' %}selected{% endif %}>closed</option>
        <option value="graded" {% if game.status=='graded' %}selected{% endif %}>graded</option>
      </select>
    </div>
    {% endif %}

    <!-- odds lines -->
    <div class="col-md-2">
      <label class="form-label">ML Home</label>
      <input class="form-control" name="ml_home" value="{{ game.ml_home if game else '' }}">
    </div>
    <div class="col-md-2">
      <label class="form-label">ML Away</label>
      <input class="form-control" name="ml_away" value="{{ game.ml_away if game else '' }}">
    </div>

    <div class="col-md-2">
      <label class="form-label">Spread (home)</label>
      <input class="form-control" name="spread_line" value="{{ game.spread_line if game else '' }}" placeholder="-6.5">
    </div>
    <div class="col-md-2">
      <label class="form-label">Spread Home Odds</label>
      <input class="form-control" name="spread_home_odds" value="{{ game.spread_home_odds if game else '' }}" placeholder="-110">
    </div>
    <div class="col-md-2">
      <label class="form-label">Spread Away Odds</label>
      <input class="form-control" name="spread_away_odds" value="{{ game.spread_away_odds if game else '' }}" placeholder="-110">
    </div>

    <div class="col-md-2">
      <label class="form-label">Total (O/U)</label>
      <input class="form-control" name="total_points" value="{{ game.total_points if game else '' }}" placeholder="55.5">
    </div>
    <div class="col-md-2">
      <label class="form-label">Over Odds</label>
      <input class="form-control" name="over_odds" value="{{ game.over_odds if game else '' }}" placeholder="-110">
    </div>
    <div class="col-md-2">
      <label class="form-label">Under Odds</label>
      <input class="form-control" name="under_odds" value="{{ game.under_odds if game else '' }}" placeholder="-110">
    </div>
  </div>

  <div class="mt-3">
    <button class="btn btn-primary">Save Game Details</button>
    <a class="btn btn-secondary" href="{{ url_for('admin_games') }}">Cancel</a>
  </div>
</form>

{% if not game %}
  <hr>
  <p class="text-muted">Save this game first to add props.</p>
{% else %}
  <hr>
  <div class="d-flex align-items-center justify-content-between mb-2">
    <h4 class="mb-0">Props for {{ game.away_team }} @ {{ game.home_team }}</h4>
  </div>

  <!-- Add new prop -->
  <div class="card mb-3">
    <div class="card-body">
      <h5 class="card-title">Add New Prop</h5>
      <form method="post" action="{{ url_for('admin_prop_new', game_id=game.id) }}">
        <!-- ... same fields as before ... -->
      </form>
    </div>
  </div>

  <!-- Existing props -->
  {% set props_list = props if props is defined else (game.props if game.props is defined else []) %}
  <div class="card">
    <div class="card-body">
      <h5 class="card-title">Existing Props</h5>
      {% if props_list and props_list|length > 0 %}
        <div class="table-responsive">
          <form method="post" action="{{ url_for('admin_grade_game', game_id=game.id) }}">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>ID</th><th>Name</th><th>Type</th>
                  <th class="text-center">Line</th>
                  <th class="text-center">Odds</th>
                  <th class="text-center">Grade Input</th>
                </tr>
              </thead>
              <tbody>
                {% for p in props_list %}
                <tr>
                  <td>{{ p.id }}</td>
                  <td>{{ p.name }}</td>
                  <td>{{ p.prop_type }}</td>
                  <td class="text-center">{{ p.line if p.prop_type == 'OU' else '—' }}</td>
                  <td class="text-center">
                    {% if p.prop_type == 'OU' %}
                      O {{ p.over_odds }} / U {{ p.under_odds }}
                    {% else %}
                      YES {{ p.yes_odds }} / NO {{ p.no_odds }}
                    {% endif %}
                  </td>
                  <td class="text-center">
                    {% if p.prop_type == 'OU' %}
                      <input type="number" step="0.01" name="prop_value_{{ p.id }}"
                             class="form-control form-control-sm d-inline-block" style="width:120px"
                             placeholder="Result value">
                    {% else %}
                      <select name="prop_value_{{ p.id }}" class="form-select form-select-sm d-inline-block" style="width:120px">
                        <option value="">—</option>
                        <option value="true">YES</option>
                        <option value="false">NO</option>
                      </select>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            <div class="mt-3">
              <button class="btn btn-success">Save & Grade Game + Props</button>
            </div>
          </form>
        </div>
      {% else %}
        <p class="text-muted mb-0">No props yet for this game.</p>
      {% endif %}
    </div>
  </div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
  const propTypeSelect = document.getElementById('prop-type-select');
  const ouFields = document.getElementById('ou-fields');
  const ynFields = document.getElementById('yn-fields');
  function togglePropFields() {
    if(!propTypeSelect) return;
    if (propTypeSelect.value === 'OU') {
      ouFields.style.display = 'flex'; 
      ynFields.style.display = 'none';
    } else {
      ouFields.style.display = 'none';
      ynFields.style.display = 'flex';
    }
  }
  if (propTypeSelect) {
    togglePropFields();
    propTypeSelect.addEventListener('change', togglePropFields);
  }
});
</script>
{% endblock %}